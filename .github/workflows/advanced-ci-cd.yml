# Advanced CI/CD Pipeline with Security and Quality Checks
name: Advanced CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'
  PYTHON_VERSION: '3.9'

jobs:
  # Job 1: Security and Dependency Check
  security-check:
    runs-on: ubuntu-latest
    name: Security & Dependency Audit
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js for security audit
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Frontend security audit
      working-directory: ./frontend
      run: |
        if [ -f package-lock.json ]; then
          npm audit --audit-level=moderate
        else
          echo "No package-lock.json found, skipping frontend audit"
        fi
      continue-on-error: true
        
    - name: Admin frontend security audit
      working-directory: ./admin_frontend
      run: |
        if [ -f package-lock.json ]; then
          npm audit --audit-level=moderate
        else
          echo "No package-lock.json found, skipping admin frontend audit"
        fi
      continue-on-error: true
      
    - name: Set up JDK for backend security check
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Backend security check
      working-directory: ./backend
      run: |
        ./mvnw dependency-check:check -DfailBuildOnCVSS=7
      continue-on-error: true

  # Job 2: Backend Build with Enhanced Testing
  backend-build:
    runs-on: ubuntu-latest
    name: Backend Build & Test
    needs: security-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('backend/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Validate Maven wrapper
      working-directory: ./backend
      run: |
        if [ ! -f mvnw ]; then
          echo "Maven wrapper not found!"
          exit 1
        fi
        chmod +x mvnw
        
    - name: Compile backend
      working-directory: ./backend
      run: ./mvnw clean compile
      
    - name: Run unit tests (allow failure for now)
      working-directory: ./backend
      run: ./mvnw test
      continue-on-error: true
      
    - name: Generate test report
      working-directory: ./backend
      run: |
        if ./mvnw surefire-report:report 2>/dev/null; then
          echo "âœ… Test reports generated successfully"
        else
          echo "âš ï¸ Could not generate test reports - may be due to test failures"
        fi
      continue-on-error: true
      
    - name: Package application
      working-directory: ./backend
      run: ./mvnw package -DskipTests
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-test-results
        path: |
          backend/target/surefire-reports/
          backend/target/site/surefire-report.html
      continue-on-error: true
        
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v3
      with:
        name: backend-jar
        path: backend/target/*.jar

  # Job 3: Frontend Build with Code Quality
  frontend-build:
    runs-on: ubuntu-latest
    name: Frontend Build & Quality Check
    needs: security-check
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: frontend/node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-
          ${{ runner.os }}-node-
        
    - name: Install dependencies
      working-directory: ./frontend
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
        
    - name: Run ESLint
      working-directory: ./frontend
      run: |
        echo "ðŸ” Running ESLint..."
        if npm run lint; then
          echo "âœ… Frontend linting passed"
        else
          echo "âš ï¸ Frontend linting found issues (non-blocking for build)"
          echo "Continuing with build process..."
        fi
      continue-on-error: true
      
    - name: Build application
      working-directory: ./frontend
      run: npm run build
      
    - name: Check build size
      working-directory: ./frontend
      run: |
        if [ -d dist ]; then
          echo "Build size:"
          du -sh dist/
          find dist/ -name "*.js" -exec wc -c {} + | sort -n
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-dist-node${{ matrix.node-version }}
        path: frontend/dist/

  # Job 4: Admin Frontend Build
  admin-frontend-build:
    runs-on: ubuntu-latest
    name: Admin Frontend Build & Quality Check
    needs: security-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: admin_frontend/node_modules
        key: ${{ runner.os }}-admin-node-${{ hashFiles('admin_frontend/package-lock.json') }}
        restore-keys: ${{ runner.os }}-admin-node-
        
    - name: Install dependencies
      working-directory: ./admin_frontend
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
        
    - name: Run ESLint
      working-directory: ./admin_frontend
      run: |
        echo "ðŸ” Running ESLint..."
        if npm run lint; then
          echo "âœ… Admin frontend linting passed"
        else
          echo "âš ï¸ Admin frontend linting found issues (non-blocking for build)"
          echo "Continuing with build process..."
        fi
      continue-on-error: true
      
    - name: Build application
      working-directory: ./admin_frontend
      run: npm run build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: admin-frontend-dist
        path: admin_frontend/dist/

  # Job 5: Data Pipeline Quality Check
  data-pipeline-check:
    runs-on: ubuntu-latest
    name: Data Pipeline Quality & Test
    needs: security-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('data-pipeline/requirements.txt') }}
        restore-keys: ${{ runner.os }}-pip-
        
    - name: Install dependencies
      working-directory: ./data-pipeline
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black pytest
        
    - name: Code formatting check
      working-directory: ./data-pipeline
      run: |
        black --check --diff .
      continue-on-error: true
        
    - name: Lint with flake8
      working-directory: ./data-pipeline
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Test Python files syntax
      working-directory: ./data-pipeline
      run: |
        python -m py_compile $(find . -name "*.py")
        
    - name: Run tests (if any)
      working-directory: ./data-pipeline
      run: |
        if [ -d tests ] || find . -name "*test*.py" | grep -q .; then
          pytest -v
        else
          echo "No tests found, skipping pytest"
        fi
      continue-on-error: true

  # Job 6: Integration Tests (Optional)
  integration-tests:
    runs-on: ubuntu-latest
    name: Integration Tests
    needs: [backend-build, frontend-build, admin-frontend-build, data-pipeline-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: trippy_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download backend JAR
      uses: actions/download-artifact@v3
      with:
        name: backend-jar
        path: ./backend/target/
        
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Run integration tests
      working-directory: ./backend
      env:
        SPRING_PROFILES_ACTIVE: test
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/trippy_test
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: test
      run: |
        ./mvnw test -Dtest=**/*IntegrationTest
      continue-on-error: true

  # Job 7: Build Status Report
  build-status:
    runs-on: ubuntu-latest
    name: Build Status Report
    needs: [security-check, backend-build, frontend-build, admin-frontend-build, data-pipeline-check]
    if: always()
    
    steps:
    - name: Generate build report
      run: |
        echo "## ðŸ—ï¸ Build Status Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Security Check | ${{ needs.security-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend | ${{ needs.backend-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | ${{ needs.frontend-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Admin Frontend | ${{ needs.admin-frontend-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Data Pipeline | ${{ needs.data-pipeline-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.security-check.result }}" == "success" && 
              "${{ needs.backend-build.result }}" == "success" && 
              "${{ needs.frontend-build.result }}" == "success" && 
              "${{ needs.admin-frontend-build.result }}" == "success" && 
              "${{ needs.data-pipeline-check.result }}" == "success" ]]; then
          echo "ðŸŽ‰ **All builds completed successfully!**" >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "âš ï¸ **Some builds encountered issues. Please check the logs above.**" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi